= ğŸ‹ğŸ™ Docker compose

image::2073552164-image2.png[height=550px]

== ğŸŒğŸ¡ Un cas de la vraie vie

Une application riche repose souvent sur plusieurs Ã©lÃ©ments techniques Ã  coordonner ensemble.

(Apache, Tomcat, Node, MongoDB, ElasticSearch, Logstash, etc.)

Comment automatiser ces dÃ©ploiements ?

[%autoanimate]
== ğŸ“œğŸ’» On pourrait tout scripterâ€¦

[source,bash]
----
include::../code-samples/compose/script.sh[]
----

[%autoanimate]
== ğŸ“œğŸ’» Tout scripter

image::351794078-image3.gif[]

[%step]
- Et tout lancer indÃ©pendamment ?
- Et tout monitorer un par un ?
- Peut mieux faire nan ?

[%autoanimate]
== ğŸ‹ğŸ™ docker compose.yml

[source,dockerfile]
----
services:
----
[%autoanimate]
== ğŸ‹ğŸ™ docker compose.yml

[source,dockerfile]
----
services:
  apache:

          
               
                
                            
            
                                                                         
  middle:
            
                
                  
  db:
----

[%autoanimate]
== ğŸ‹ğŸ™ docker compose.yml

[source,dockerfile]
----
services:
  apache:
    image: "my-httpd:2.4"
          
               
                
                            
            
                                                                         
  middle:
            
                
                  
  db:
----
[%autoanimate]
== ğŸ‹ğŸ™ docker compose.yml

[source,dockerfile]
----
services:
  apache:
    image: "my-httpd:2.4"
    ports:
      - "80:80"
                
                            
            
                                                                         
  middle:
            
                
                  
  db:
----

[%autoanimate]
== ğŸ‹ğŸ™ docker compose.yml

[source,dockerfile]
----
services:
  apache:
    image: "my-httpd:2.4"
    ports:
      - "80:80"
    environment:
      - MIDDLE_HOST_1=middle
            
                                                                         
  middle:
            
                
                  
  db:
----

[%autoanimate]
== ğŸ‹ğŸ™ docker compose.yml

[source,dockerfile]
----
services:
  apache:
    image: "my-httpd:2.4"
    ports:
      - "80:80"
    environment:
      - MIDDLE_HOST_1=middle
    volumes:
      - ./etc/httpd/workers.properties:/etc/httpd/conf/workers.properties
  middle:
            
                
                  
  db:

----
[%autoanimate]
== ğŸ‹ğŸ™ docker compose.yml

[source,dockerfile]
----
services:
  apache:
    image: "my-httpd:2.4"
    ports:
      - "80:80"
    environment:
      - MIDDLE_HOST_1=middle
    volumes:
      - ./etc/httpd/workers.properties:/etc/httpd/conf/workers.properties
  middle:
    build: .
                
                  
  db:
----

[%autoanimate]
== ğŸ‹ğŸ™ docker compose.yml

[source,dockerfile]
----
services:
  apache:
    image: "my-httpd:2.4"
    ports:
      - "80:80"
    environment:
      - MIDDLE_HOST_1=middle
    volumes:
      - ./etc/httpd/workers.properties:/etc/httpd/conf/workers.properties
  middle:
    build: .
    environment:
      - DB_HOST=db
  db:
----

[%autoanimate]
== ğŸ‹ğŸ™ docker compose.yml

[source,dockerfile]
----
services:
  apache:
    image: "my-httpd:2.4"
    ports:
      - "80:80"
    environment:
      - MIDDLE_HOST_1=middle
    volumes:
      - ./etc/httpd/workers.properties:/etc/httpd/conf/workers.properties
  middle:
    build: .
    environment:
      - DB_HOST=db
  db:
    image: "mysql:5.6"
----

[%autoanimate]
== ğŸ‹ğŸ™ docker compose.yml

[source,dockerfile]
----
services:
  apache:
    image: "my-httpd:2.4"
    ports:
      - "80:80"
    environment:
      - MIDDLE_HOST_1=middle
    volumes:
      - ./etc/httpd/workers.properties:/etc/httpd/conf/workers.properties
  middle:
    build: .
    environment:
      - DB_HOST=db
  db:
    image: "mysql:5.6"
    ports:
      - "3306:3306"

----

[%autoanimate]
== ğŸ¤”â¡ï¸ Et aprÃ¨s ?

[source,bash]
----
docker compose up -d
docker compose build
docker compose logs
docker compose stop
docker compose restart
docker compose down
----

== ğŸğŸ”¢ Ordre de dÃ©marrage

pour attendre qu'un container rÃ©ponde sur le rÃ©seau avant de dÃ©marrer... Voir exemple de myfirstandroid et travail ashutosh

image::47642838-image4.png[]

[.notes]
--
Dans le temps, on recommandait de faire un script qui attendait que le service soit dÃ©marrÃ© avant de continuer.
https://github.com/vishnubob/wait-for-it
--

== Transformer son application en docker compose

https://github.com/jwilder/dockerize

== Travaux pratiques #12

image::497269344-image5.png[]

https://gitlab.univ-artois.fr/bruno.verachten/devops-docker-tp12.git

