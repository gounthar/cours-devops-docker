[%auto-animate]
= Utiliser ENV dans le Dockerfile plutôt que RUN export

L’utilisation de `ENV` dans un Dockerfile est nettement plus conforme aux bonnes pratiques Docker que `RUN export` ! Voici les approches les plus adaptées :

[%auto-animate]
== 1. Utiliser ENV dans le Dockerfile (Recommandé)

[source,dockerfile]
----
ENV https_proxy=http://cache-etu.univ-artois.fr:3128/
ENV http_proxy=http://cache-etu.univ-artois.fr:3128/

# Votre gestionnaire de paquets utilisera désormais le proxy
RUN apk update && apk add your-package
----

[%auto-animate]
== 2. Build multi-étapes – Proxy uniquement lorsque nécessaire

[source,dockerfile]
----
# Étape de build avec proxy
FROM alpine:latest as builder
ENV https_proxy=http://cache-etu.univ-artois.fr:3128/
ENV http_proxy=http://cache-etu.univ-artois.fr:3128/
RUN apk update && apk add build-dependencies

# Étape finale sans proxy
FROM alpine:latest
COPY --from=builder /built-artifacts /app
----

[%auto-animate]
== 3. Variables d’environnement au moment du build Docker

[source,bash]
----
docker build --build-arg https_proxy=http://cache-etu.univ-artois.fr:3128/ .
----

Avec le Dockerfile correspondant :

[source,dockerfile]
----
ARG https_proxy
ARG http_proxy

RUN apk update && apk add your-package
----

[%auto-animate]
== 4. Configuration du démon Docker (à l’échelle du système)

Ajouter dans `/etc/docker/daemon.json` :

[source,json]
----
{
  "proxies": {
    "default": {
      "httpProxy": "http://cache-etu.univ-artois.fr:3128",
      "httpsProxy": "http://cache-etu.univ-artois.fr:3128",
      "noProxy": "localhost,127.0.0.1"
    }
  }
}
----

Puis redémarrer Docker :

[source,bash]
----
sudo systemctl restart docker
----

[%auto-animate]
== 5. Configuration spécifique à l’utilisateur du client Docker

Créer ou modifier `~/.docker/config.json` :

[source,json]
----
{
  "proxies": {
    "default": {
      "httpProxy": "http://cache-etu.univ-artois.fr:3128",
      "httpsProxy": "http://cache-etu.univ-artois.fr:3128"
    }
  }
}
----

[%auto-animate]
== Pourquoi ENV est préférable à RUN export

* *Persistance* : `ENV` définit la variable pour toutes les commandes `RUN` suivantes.
* *Clarté* : rend explicite la dépendance au proxy dans le Dockerfile.
* *Arguments de build* : permet de les surcharger au moment du build sans modifier le Dockerfile.

=== Approches recommandées
- Utilisez l’option *#1 (ENV dans le Dockerfile)* si le proxy est toujours requis.
- Utilisez l’option *#3 (arguments de build)* si vous avez besoin de flexibilité.

L’approche avec `RUN export` ne fonctionne que pour une seule commande, ce qui explique pourquoi `ENV` est plus fiable et plus conforme à l’esprit Docker !
